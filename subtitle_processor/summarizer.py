import os

from openai import OpenAI

from utils import json_repair
from configs.subtitle_config import SUMMARIZER_PROMPT


class SubtitleSummarizer:
    def __init__(self, model) -> None:
        base_url = os.getenv('OPENAI_BASE_URL')
        api_key = os.getenv('OPENAI_API_KEY')

        if not base_url or not api_key:
            raise ValueError("环境变量 OPENAI_BASE_URL 和 OPENAI_API_KEY 必须设置")

        self.model = model
        self.client = OpenAI(base_url=base_url, api_key=api_key)

    def summarize(self, subtitle_content: str) -> str:
        response = self.client.chat.completions.create(
            model=self.model,
            stream=False,
            messages=[
                {"role": "system", "content": SUMMARIZER_PROMPT},
                {"role": "user", "content": f"summarize the video content:\n{subtitle_content}"}
            ]
        )
        return str(json_repair.loads(response.choices[0].message.content))

if __name__ == "__main__":
    # os.environ['OPENAI_BASE_URL'] = 'https://api.gptgod.online/v1'
    # os.environ['OPENAI_API_KEY'] = 'sk-4StuHHm6Z1q0VcPHdPTUBdmKMsHW9JNZKe4jV7pJikBsGRuj'
    # MODEL = "gpt-4o-mini"
    os.environ['OPENAI_BASE_URL'] = 'https://api.turboai.one/v1'
    os.environ['OPENAI_API_KEY'] = 'sk-ZOCYCz5kexAS3X8JD3A33a5eB20f486eA26896798055F2C5'
    MODEL = "gpt-4o-mini"
    summarizer = SubtitleSummarizer(model=MODEL)
    example_subtitles = {0: '既然是想做并发编程', 1: '比如说肯定是想干嘛', 2: '开启多条线程来同时执行任务',
                         3: '那怎么去开启新线程呢', 4: '有两种方法啊',
                         5: '那开启新线程的第一种方法怎么做呢', 6: '来我直接给你看了啊', 7: '我们看下第一种方法首先',
                         8: 'Sprite Sprite直接干嘛呢',
                         9: 'new Sprite你看', 10: '这样的话就可以创建一条新线索', 11: '那应该用哪个构造方法呢',
                         12: '我建议大家先用这个',
                         13: '看到这个', 14: '你看啊它是要求我们传一个什么', 15: 'Runnable那run up是个啥东西呢',
                         16: '它其实是一个接口',
                         17: '那一说到是个接口', 18: '我们能想到的肯定是new一个什么呢', 19: '匿名啊new一个匿名类对象',
                         20: '可以发现',
                         21: '怎么样哎', 22: '他是有个什么方法', 23: '有个run方法', 24: '而且他只有一个方法',
                         25: '那说明这是个什么接口啊',
                         26: '函数式接口', 27: '那很明显可以通过什么', 28: '可以通过lamb的表达式来优化它啊',
                         29: '这个我们讲过了', 30: '好吧那现在这样',
                         31: '是这样是什么意思呢', 32: '好很简单', 33: '你就把你这一条线程想执行的任务',
                         34: '写在run方法里面就可以了', 35: '这是一条新线程', 36: '那这条线程叫什么呢',
                         37: '我们是可以直接spread', 38: '点什么carry spread', 39: '是不是可以获取一下',
                         40: '当前这条线程叫什么名字', 41: '就是把它打印出来嘛', 42: '好这样就可以了',
                         43: '当然你也可以直接通过这个get name', 44: '拿到当前线程的这个名字', 45: '这样的话',
                         46: '你就不用怎么样', 47: '你就不用看到别的打印信息了', 48: '你只会看到它的一个名字',
                         49: '这样也可以', 50: '好这是一条新线程', 51: '那问题是这个', 52: '县城这样就启动了吗',
                         53: 'no这样仅仅是创建了县城对象', 54: '但是里面还还没有启动这个县城',
                         55: '那怎么启动这个县城呢', 56: '是这样子的', 57: '直接调用我们这个stride', 58: '什么',
                         59: '注意是要start', 60: 'start就是开始开启这个线程', 61: '好了我们只要调用这个start',
                         62: '它就会去开启一这条新线程', 63: '然后的话', 64: '执行它里面的任务', 65: '这样就可以了',
                         66: '这个时候我们可以跑一遍这个程序', 67: '你看新线程spread 0 哎',
                         68: '这条线程的名字叫做spread 0', 69: '注意这个名字不是我起的啊', 70: '是他给我们自己编了',
                         71: '好那线程能不能设置名字呢', 72: '可以的我们通过这个send name', 73: '可以设置它的名字',
                         74: '对吧比如说这一条叫县城666', 75: '下起来啊', 76: '这个时候我们可以跑一遍这个程序',
                         77: '可以看到', 78: '你看新县城', 79: '县城666 非常非常简单啊', 80: '你乐意的话',
                         81: '你可以看一下有没有其他这个数字', 82: '比如说set priority', 83: '设置一下优先级啊',
                         84: '比如说我写个这个10', 85: '那主线程是5', 86: '那我这个是10', 87: '按理来说呃',
                         88: '优先级应该会比他大', 89: '对吧那大家可以自己这里去看一下', 90: '好吧你看',
                         91: '他说改变一下这个线程的这个优先级', 92: '然后这个参数', 93: '就是你要设置的一个优先级啊',
                         94: '呃然后', 95: '然后我看一下', 96: '还有没有别的方法', 97: '呃这样子吧',
                         98: '我们直接用set就可以了', 99: '你直接用这个set你就明白了吗', 100: '你看啊呃',
                         101: '还有一些啊', 102: '别的但是别的的话', 103: '我们暂时可能用不上', 104: '比如说像这个',
                         105: '这个是牵扯到什么', 106: '首付现成啊', 107: '这等等一些概念', 108: '这个我们先先不说了啊',
                         109: '总之常见的设置其实就是这个set number', 110: '还有set priority这个东西啊',
                         111: '好吧这个是我们现成', 112: '我们已经开启了这么一个现场了', 113: '呃那刚刚说到',
                         114: '那既然这个是个lambda', 115: '买不对', 116: '这是个函数式接口',
                         117: '那我们可以使用什么lambda表达式', 118: '来去优化一下这个代码', 119: '所以非常非常简单',
                         120: '那以后我们就可以怎么做呢', 121: '以后我们就可以这么做了',
                         122: '这个东西我们直接写成这样子', 123: '然后这个东西不要了', 124: '看就这么简单',
                         125: '开启一条新线程', 126: '这个时候我们可以跑一下', 127: '嗯这是新线程的一个名字',
                         128: '好了', 129: '呃所以看那我PPD也说了', 130: 'new runable然后直接用Lambda也是可以的',
                         131: '起接下来我们说下第二种方法', 132: '第二种方法啊', 133: '刚刚说的是第一种',
                         134: '创建线程的这个方法', 135: '我们把它放到这个位置来', 136: '刚刚是开启了一条新的线程',
                         137: '是第一种方法', 138: '好那接下来我们看一下第二种方法', 139: '看到第二种方法是这样',
                         140: '我在这个位置看到啊', 141: '我搞一个spread', 142: '一个子类', 143: '注意是spread',
                         144: '一个子类', 145: '这是第2种方法', 146: 'my strap比如说', 147: '或者说',
                         148: '这这个建成你是拿来放歌的啊', 149: '这个时候来个music spread',
                         150: '然后这个时候我们继承一下这个spread', 151: '啊注意', 152: '这是个呃',
                         153: '是spread的一个词类', 154: '那怎么用呢', 155: '看到啊', 156: '先看一下spread',
                         157: '你会发现诶', 158: '看到一个熟悉的东西runable', 159: '说白了spread',
                         160: '它也是实现了runable这个接口', 161: '了但是我们发现', 162: '这里',
                         163: '并没有要求我们自己强制实现的', 164: '那个run方法', 165: '因为我们知道',
                         166: 'run up里面', 167: '是不是有一个方法叫做run方法', 168: '这个我们都非常清楚嘛',
                         169: '对吧但是呢', 170: '我们为什么这里不要求我实现呢', 171: '那说明这个Sprite',
                         172: '它内部应该有自己的', 173: '这个run方法的一个实现', 174: '对吧因为附类里面',
                         175: '如果有这个run方法的一个实现的话', 176: '那就不要求我们自己去实现对吧',
                         177: '不要求我们这个指挥去实现', 178: '这个大家都明白了啊', 179: '呃',
                         180: '但是它里面的东西的话是是怎么样呢', 181: '呃是', 182: '是这样的一个代码',
                         183: '是吧这个代码先大家先不用去看', 184: '那我想表达个什么点呢', 185: '那我继承了这个Stretch',
                         186: '怎么做呢', 187: '重写那个转化', 188: '然后呢', 189: '把你想干的事情放在这这个地方',
                         190: '就可以了', 191: '比如说播放音乐', 192: '就这样子', 193: '然后把我们县城的名字搞一下',
                         194: '那由于呢', 195: '我们本身这个方法', 196: '就是属于县城对象了', 197: '所以这个时候',
                         198: '我们可以直接调入我们自己的get name', 199: '是不是拿到我们自己的名字',
                         200: '我们当前这条县城的名字啊', 201: '这样就可以了', 202: '好了好', 203: '那接下来怎么做呢',
                         204: '看着啊我们在这个位置的话', 205: '我们spread spread', 206: '然后new my spread',
                         207: '创建一个my spread哎', 208: '这样就可以啊', 209: '不对不是my spread',
                         210: '是music是music spread哎', 211: '这样就可以了', 212: '好那接下来',
                         213: '我们调用一下这个现成的这个start', 214: '这个方法', 215: '左边呢',
                         216: '我使用这个spread这个类型是可以的嘛', 217: '因为这个不是多态嘛啊',
                         218: '负类类型指向子类对象啊', 219: '那这个时候我们可以跑一遍', 220: '可以看到',
                         221: '你看播放音乐', 222: '然后spread 0', 223: '所以可以看到',
                         224: '这条线上也成功被我们启动了', 225: '所以我们总结一下两种方法', 226: '第一种方法',
                         227: '我们可以直接利用spread这个类', 228: '然后传入一个呃', 229: 'runable对象给他就可以了',
                         230: '然后把你的任务', 231: '放在run up的run方法里面啊', 232: '然后第二种方法',
                         233: '我们可以继承一下这个spread这个类', 234: '然后实现一下run方法',
                         235: '把你想做的事情放在这里就可以了', 236: '好吧', 237: '那现在我们再来解读一下这个spread',
                         238: '这个呃一些圆码', 239: '我们看一下啊', 240: '那他的这个start里面干了什么事情呢',
                         241: '比如说像这种方法', 242: 'start start是不是启动现成啊', 243: '那启动现成的话',
                         244: '那它里面干了什么事情呢', 245: '我们可以稍微进去看一下', 246: '呃我们进去看一下的话',
                         247: '我们可以看到这里面很很多代码', 248: '是吧啊', 249: '但是呢这些东西呢',
                         250: '应该都不是我们想要的', 251: '所以我们可以不去看', 252: '我们看一下别的',
                         253: '比如说这里有个star 0', 254: '那star 0干什么事情呢', 255: '大家可以发现哎',
                         256: '我这样star 0的话', 257: '变成一个native', 258: '注意啊以后你凡是看到native',
                         259: '就代表这是个本地方法', 260: '比如说它底层呢', 261: '我们是看不见的啊',
                         262: '是个本地方法', 263: '本地调用', 264: '你可以理解为是呃', 265: 'c C++那些东西啊',
                         266: '好吧那现在我想表达个什么点呢', 267: '大大家可能想哎', 268: '你看啊我们调用这个start',
                         269: '它其实里面干', 270: '了什么事情呢', 271: '我直接跟你讲了吧', 272: '因为这个是native啊',
                         273: '它里面干了什么事情呢', 274: '它其实里面会调用它的辱让方法', 275: '我跟你说一遍啊',
                         276: 'thread', 277: '呃', 278: '调用start之后', 279: '内部会调用run方法', 280: '好说白了',
                         281: '这个start', 282: '这个内部', 283: '实际上会调用他自己的running法',
                         284: '我们找一下他自己的running法', 285: '就是哎呀我靠', 286: '这个对吧',
                         287: '好那他自己的running法会去干嘛呢', 288: '他会看一下他的tag', 289: '如果target不弹空',
                         290: '就调入target的running', 291: '那target是什么东西呢', 292: '看到答案了吗runable',
                         293: '那这个runable是什么地方传进来的', 294: '我们看一下啊', 295: '应该是在这个位置',
                         296: '这个位置看到啊', 297: '你看这个就是target', 298: '好吧那我们就明白答案了',
                         299: '也就说白了', 300: '这个现场的这个启动执行任务', 301: '是怎么一个流程呢',
                         302: '我们调用star的方法', 303: '他肯定会就就去', 304: '会去开启一条新的线程',
                         305: '就真正实现多线程', 306: '然后这个新起的这个线程', 307: '会去干什么事情呢',
                         308: '会调用线程对象自己的run方法', 309: '一旦调用他自己的run方法',
                         310: '他又会调用他这个target的run方法', 311: '所以最终这条线上',
                         312: '里面执行的任务就是这一句了', 313: '哎', 314: '但是我们刚刚演示了另外一种做法',
                         315: '把run方法给干嘛', 316: '给重写掉啊', 317: '我继承了spread', 318: '把run方法给重写掉了',
                         319: '那把run方法一重写', 320: '会发生什么事情呢', 321: '大家想象一下',
                         322: '你看你调用这个现成的start', 323: '我刚刚怎么说的', 324: '会调用现成他自己的run方',
                         325: '法所以这个时候调用music spread run方法', 326: '所以的话',
                         327: '怎么样你新县城里面执行的任务', 328: '就是这一块了', 329: '所以我相信我讲完之后呢',
                         330: '这两种就是实现多县城的方案', 331: '大家应该都非常清楚了啊', 332: '它本质其实就是就是呃',
                         333: '调用star方法之后呢', 334: '会调用县城自己的办法吗', 335: '啊就这么简单',
                         336: '好了那现在我再说一个注意点', 337: '说一个注意点啊', 338: '什么注意点呢',
                         339: '那同学们可能会问', 340: '那既然是这样子', 341: 'start内部会去干嘛呢',
                         342: '会去这个调用run方法', 343: '那run方法里面', 344: '才是我们这个县城里面',
                         345: '真正要干的事情', 346: '是吧那你可能会问', 347: '那我能不能直接sprite调用run方法呢',
                         348: '这样是不是也是多县城呢', 349: '好现在我可以给你跑一下', 350: '好',
                         351: '看到我们看到的这个结果是什么呢', 352: '首先我们现在', 353: '现在啊播放音乐',
                         354: 'spread 0 哎', 355: '大家可能觉得哎', 356: '是不是也是一样呢',
                         357: '这个时候我们把它关掉', 358: '我把这个打开看着啊', 359: '你看播放音乐呃',
                         360: 'spread 0是吧', 361: '然后这个时候把它关掉', 362: '哎没什么区别啊', 363: '那是even',
                         364: '以后我可以直接调这个run呢', 365: '啊这样子', 366: '我们再来干一件事情',
                         367: '刚刚呢我在播放音乐', 368: '后面的东西是什么', 369: '是get name',
                         370: '是不是拿到这条线上的这个名字', 371: '其实你真正想知道这个',
                         372: '这个run是在哪一条线上呢', 373: '我们最好怎么做呢', 374: '最好是sprite',
                         375: '点current sprite', 376: '然后点get name', 377: '好我们跑一下', 378: '看到了吗',
                         379: '们主线程你直接down', 380: 'run其实它真正是在主线程执行的',
                         381: '然后这个时候把这个东西给关掉', 382: '然后这个时候我们呃来start一下',
                         383: '然后这个时候跑一下', 384: '你看spread 0', 385: '什么意思呢', 386: '好大家不要晕',
                         387: '不要晕啊', 388: '我现在给你讲清楚一个问题', 389: '我刚刚这里怎么写',
                         390: '我刚刚这里是yeah name', 391: 'get name是什么意思啊', 392: '是不是拿到这一个县城的名字啊',
                         393: '实际上只要你new music scrap', 394: '就是你new了这么一个对象之后', 395: '他的内部的话',
                         396: '就会给他分配一个名字', 397: '说白了听清楚', 398: '说白了这个县城只要牛出来',
                         399: '我管你这个县城有没有启动', 400: '有没有真正实现多县城', 401: '总之你这个县城对象牛出来',
                         402: '他就有个名字', 403: '他就有个名字', 404: '所以思考一下', 405: '这个run方法',
                         406: '不管是在哪一条线上执行的', 407: '这个get number', 408: '是不是都是拿到music spread名字',
                         409: '所以的话', 410: '不管你是通过run', 411: '还是通过start', 412: '你只要执行到这个地方',
                         413: '我的get name的结果都是一样的', 414: '都是spread 0', 415: '你看', 416: '都是Sprite 0',
                         417: '对吧好', 418: '但实际上', 419: '你真正想知道这个run方法', 420: '是在哪一条线上执行的',
                         421: '你最好不要这么写', 422: '应该是Sprite', 423: 'spread点current spread点点name',
                         424: '这样是不是才能准确知道', 425: '当前这些代码是直行在哪一条线程了',
                         426: '好吧那现在我们来看一下答案', 427: '就是如果我们是遵规守矩的',
                         428: '调用我们的这个spread点store', 429: '这是比较正规的启动线程的一种方式',
                         430: '这个时候我们可以看到这个', 431: 'run方法是在一条新线程里面执行的',
                         432: '那如果你是直接调用这个run', 433: '你直接调用这个run', 434: '去执行这个代码的话',
                         435: '好了那现在我们来看一下', 436: '它是在主线程执行的', 437: '说白了我先给你做一个总结啊',
                         438: '总结就是你要想真正启动这个线程', 439: '真正想开一条线程出来的话',
                         440: '同学们应该是调用start', 441: '而不是直接调用run', 442: '直接调用run',
                         443: '你知道相当于什么吗', 444: '相当于什么', 445: '相当于这样子', 446: '你看我给你这样写吧',
                         447: '嗯现在你理解吗', 448: '你直接调用run', 449: '不就相当于将music',
                         450: 'red对象的这个run方法', 451: '执行一下吗', 452: '而你这个run方法又是在什么地方',
                         453: '是在闷方法里面调了', 454: '那不就相当于闷方法里面调用乱方法',
                         455: '那不是还是在主线层吗', 456: '我相信大家是可以理解这一点啊',
                         457: '所以你直接去执行它代码', 458: '就是在闷方法所在的县城执行代码', 459: '所以',
                         460: '你现在乱方法里面代码是在主县城了', 461: '这个需要说到家啊',
                         462: '好了那现在再看一个问题', 463: '那为什么我叼start就不一样呢', 464: '是这样子的',
                         465: 'start', 466: '我们明显可以看到它这里有个start 0', 467: '这个方法是个native的',
                         468: '那这个native native是在干什么事情呢', 469: '是在向CPU操作系统申申请现成资源',
                         470: '因为开启现成', 471: '他是要分配一些资源给他的', 472: '比如说',
                         473: '要分配一个专门的占空间给这个现成', 474: '等等一些东西', 475: '所以',
                         476: '因为有些资源是每一个县城都要有的', 477: '每一个县城都要配备的一些资源',
                         478: '所以这个START0', 479: '是像操作系统向向CPU申请一些资源', 480: '那这个资源申请到了好了',
                         481: '接下来他内部的话会干嘛呢', 482: '就会去把调用你的run方法', 483: '而你run方法',
                         484: '就真正是在那一条新的线程上面', 485: '执行的', 486: '大家能理解我在说什么吗',
                         487: '以后不要直接调用县城的run', 488: '而是要调成调用县城的start', 489: '因为只有经过了start',
                         490: '他才能真正办到', 491: '给这个县城分配一些', 492: '县城需要的一些资源',
                         493: '才能真正把这个县城给开起来', 494: '真正实现了多县城', 495: '不要给我傻乎乎的',
                         496: '直接调用这个run啊', 497: '就这么简单', 498: '好', 499: '然后再往下看',
                         500: '然后刚刚也说到', 501: '直接调用现成的run方法', 502: '并不能开启新现成',
                         503: '调用现成的start方法', 504: '才能成功开启现成啊', 505: '而且stread这个类',
                         506: '它是实现了run up接口的', 507: '刚刚已经说过这个问题了'}
    example_subtitles = dict(list(example_subtitles.items())[:100])

    content = "".join(example_subtitles.values())
    result = summarizer.summarize(content)
    print(result)